#
# top level directory for RTEMS build tree
#
# Modified by Jiri to implement autoconf and cygnus one-tree build
#
#  $Id$
#

@SET_MAKE@
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@
target = @target@
manext = 1
mandir = @mandir@/man$(manext)
program_prefix = @program_prefix@

RTEMS_ROOT = @RTEMS_ROOT@
PROJECT_ROOT = @PROJECT_ROOT@

VPATH=@srcdir@

ifeq ($(RTEMS_BSP),)
  RTEMS_BSP = @RTEMS_BSP_LIST@
endif

MAKE_CONFIG_EXTRA_DIR_PART=c/

include $(RTEMS_ROOT)/make/main.cfg

MTARGETS = all install $(TARGET_VARIANTS) $(TARGET_VARIANTS:%=%_all) \
  $(TARGET_VARIANTS:%=%_install) $(TARGET_VARIANTS:%=%_tests) \
  clean_wrapup distclean clean_dirs clean_tools tests clean depend

.PHONY: clean_modules make_subdir

EXIT_CMD = exit 1

# Don't pass flags from previous make - especially NOT CFLAGS 
override MAKEFLAGS=

#            \"XCFLAGS=$(CFLAGS_FOR_TARGET)\"

$(MTARGETS): make_subdir
	BASEDIR=`pwd`; \
	for bsp in $(RTEMS_BSP) xxx; \
	do if [ $$bsp != xxx ] ; then  \
	    cd $$BASEDIR; \
	    cmd="cd c; $(MAKE) RTEMS_BSP=$$bsp $(FLAGS_TO_PASS) \
            $@" ; \
	    eval $$cmd || $(EXIT_CMD); \
	fi; done; 

clean_modules:
	rm -f src/Modules/rtems/.moduleavailcache
	rm -f src/Modules/rtems/.moduleavailcachedir

make_subdir:
	if [ ! -d make ] ; then \
	  (cd $(srcdir)/c; tar cf - make/compilers make/custom \
	        make/directory.cfg make/leaf.cfg make/lib.cfg make/main.cfg \
		make/Templates/Makefile.dir \
	        make/Templates/Makefile.leaf make/Templates/Makefile.lib) | \
		tar xpBf - ; rm -rf make/CVS make/*/CVS ; \
	  cp c/make/Templates/Makefile.inc make/Templates/Makefile.inc ; \
	  cp c/make/host.cfg make/host.cfg ; \
	  cp c/make/target.cfg make/target.cfg ; \
	fi
