#
# top level directory for RTEMS build tree
#
# Modified by Jiri to implement autoconf and cygnus one-tree build
#
#  $Id$
#

@SET_MAKE@
srcdir = @srcdir@
top_srcdir = @top_srcdir@
top_builddir = .

INSTALL = @INSTALL@

RTEMS_ROOT = $(top_srcdir)/@RTEMS_TOPdir@
PROJECT_ROOT = @PROJECT_ROOT@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@
target = @target@
manext = 1
mandir = @mandir@/man$(manext)
program_prefix = @program_prefix@

export bindir

VPATH=@srcdir@

ifeq ($(RTEMS_BSP),)
  RTEMS_BSP = @RTEMS_BSP_LIST@
endif

include $(RTEMS_ROOT)/make/main.cfg

MTARGETS = pre_install_src all install $(TARGET_VARIANTS) $(TARGET_VARIANTS:%=%_all) \
  $(TARGET_VARIANTS:%=%_install) $(TARGET_VARIANTS:%=%_tests) \
  clean_wrapup distclean clean_dirs clean_tools tests clean depend

EXIT_CMD = exit 1

# Don't pass flags from previous make - especially NOT CFLAGS  
# NOTE: Previous versions overrode MAKEFLAGS, but this also disables 
# a lot of useful features
# override MAKEFLAGS=

$(MTARGETS): 
	BASEDIR=`pwd`; \
	for bsp in $(RTEMS_BSP) xxx; \
	do if [ $$bsp != xxx ] ; then  \
	    cd $$BASEDIR; \
	    cmd="cd c; $(MAKE) RTEMS_BSP=$$bsp $(FLAGS_TO_PASS) \
            $@" ; \
	    eval $$cmd || $(EXIT_CMD); \
	fi; done; 

## Configuration stuff

ACLOCAL = aclocal -I aclocal
AUTOCONF = autoconf

ACLOCAL_FILES := $(wildcard $(srcdir)/aclocal/*.m4)
ACLOCAL_M4 = aclocal.m4

$(ACLOCAL_M4): configure.in $(ACLOCAL_FILES)
	-cd $(RTEMS_ROOT) && $(ACLOCAL)

config.status: $(RTEMS_ROOT)/configure
	$(SHELL) ./config.status --recheck

$(RTEMS_ROOT)/configure: $(RTEMS_ROOT)/configure.in $(ACLOCAL_M4)
	-cd $(RTEMS_ROOT) && $(AUTOCONF)

.PRECIOUS: $(ACLOCAL_M4) configure Makefile config.status

Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	cd $(top_builddir) \
	 && CONFIG_FILES=$@ CONFIG_HEADERS= $(SHELL) ./config.status
