#
#  $Id$
#
# top level directory for RTEMS build tree
# This Makefile is *not* a good example of a directory Makefile.
#

@SET_MAKE@
srcdir = @srcdir@
top_srcdir = @top_srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@
target = @target@
manext = 1
mandir = @mandir@/man$(manext)
program_prefix = @program_prefix@
VPATH = @srcdir@
RTEMS_ROOT = @RTEMS_ROOT@
PROJECT_ROOT = @PROJECT_ROOT@
RTEMS_CUSTOM = $(RTEMS_ROOT)/make/custom/$(RTEMS_BSP).cfg

include $(RTEMS_CUSTOM)
include $(RTEMS_ROOT)/make/directory.cfg

# dubious, but needed by rtems-glom ...
export PROJECT_HOME

SUB_DIRS=build-tools src

# We only make the install point for the KA9Q header files if it is enabled.
LIBKA9Q_yes_V = lib/include/ka9q
LIBKA9Q = $(LIBKA9Q_$(HAS_KA9Q)_V)

# We only make the rtems++ install point if it is enabled.
LIBRTEMSCPLUSPLUS_yes_V = lib/include/rtems++
LIBRTEMSCPLUSPLUS = $(LIBRTEMSCPLUSPLUS_$(HAS_CPLUSPLUS)_V)

# directories to be created in install point
CREATE_DIRS = \
    lib lib/include lib/include/sys lib/include/rtems \
    lib/include/rtems/score lib/include/rtems/rtems lib/include/rtems/posix \
    lib/include/netinet lib/include/libc lib/include/libc/sys \
    lib/include/motorola lib/include/zilog \
    $(LIBKA9Q) \
    $(LIBRTEMSCPLUSPLUS) \
    bin samples \
    tests tests/screens tests/screens/sptests \
    tests/screens/psxtests tests/screens/mptests \
    tests/screens/mptests/node1 tests/screens/mptests/node2 \
    build-tools update-tools

# Make all/install must include 'env'
# if something is added to TARGET_VARIANTS, then account for it here
all: env
debug: env
profile: env

install: all install_files
debug_install: env debug install_files
profile_install: env profile install_files

debug_all: debug
profile_all: profile

# top level clean/clobber will delete the install points
clean_WRAPUP = $(MAKE) clean_wrapup
clobber_WRAPUP = $(MAKE) clean_wrapup

clean_wrapup: clean_tools clean_dirs clean_modules

.PHONY:	dirs clean_wrapup clean_dirs clean_tools clean_modules env install

dirs:
	-test -d $(PROJECT_ROOT)/c/src/lib/libhwapi && \
	    (cd $(PROJECT_ROOT)/c/src/lib/libhwapi ; $(MAKE) mkdirs)
	-$(MKDIR) ${CREATE_DIRS:%=$(PROJECT_ROOT)/$(RTEMS_BSP)/%}
#	@echo Making directories in build tree ...
#	-$(foreach dir,$(CREATE_DIRS), \
#	    $(shell $(MKDIR) $(PROJECT_ROOT)/$(RTEMS_BSP)/$(dir)))

distclean: clobber

clean_dirs:
	$(RM) -r $(PROJECT_RELEASE)

clean_tools:
	cd build-tools; $(MAKE) clean

# NOTE: The wildcard on the install should pick up everything except
#       the tests directory.  This significantly minimizes the install size.


install_files:
	 -$(MKDIR) $(prefix)/
	 -$(MKDIR) $(prefix)/rtems
	 -$(MKDIR) $(prefix)/rtems/make
	 -$(MKDIR) $(prefix)/rtems/make/compilers
	 -$(MKDIR) $(prefix)/rtems/make/custom
	-rm -rf $(prefix)/rtems/$(RTEMS_BSP)
	cd ../; tar cf - make $(RTEMS_BSP)/[bilsu]* | \
		(cd $(prefix)/rtems; tar xpBf - )
	(echo RTEMS_BSP = $(RTEMS_BSP) ; $(CAT) make/Templates/Makefile.inc ) \
		> $(prefix)/rtems/$(RTEMS_BSP)/Makefile.inc

tests:
	cd src/tests; $(MAKE) all

env:    $(SRCS) dirs
