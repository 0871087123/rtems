##
##  $Id$
##
##  build and install "glommed" librtemsbsp.a
##

include $(top_srcdir)/automake/compile.am

## Setup the variant build subdirectory
ARCH_OPTIMIZE_V = o-optimize
ARCH_DEBUG_V = o-debug
                                                                                
ARCH__V = $(ARCH_OPTIMIZE_V)
ARCH = $(ARCH_$(VARIANT_V)_V)

project_lib_DATA = $(ARCH)/librtemsbsp$(LIB_VARIANT).a
CLEANFILES = o-optimize/librtemsbsp.a
CLEANFILES += o-debug/librtemsbsp_g.a

SRCS = ../support/libsupport$(LIB_VARIANT).a

if HAS_LIBBSP
if HAS_WRAPUP_LIBBSP
SRCS += \
    ../lib/libbsp/@RTEMS_CPU@/@RTEMS_BSP_FAMILY@/wrapup/$(ARCH)/libbsp.a
else
SRCS += \
    ../lib/libbsp/@RTEMS_CPU@/@RTEMS_BSP_FAMILY@/libbsp$(LIB_VARIANT).a
endif
endif

if HAS_NETWORKING
if HAS_POSIX
SRCS += ../libnetworking/rtems_webserver/libhttpd$(LIB_VARIANT).a
endif
SRCS += ../libnetworking/pppd/libpppd$(LIB_VARIANT).a
SRCS += ../libnetworking/rtems_servers/libftpd$(LIB_VARIANT).a
SRCS += ../libnetworking/rtems_telnetd/libtelnetd$(LIB_VARIANT).a
endif

if HAS_RDBG
SRCS += ../librdbg/librdbg$(LIB_VARIANT).a
endif

# FIXME: ATM, there is no libcpu.a, anymore.
# SRCS += $(wildcard $(PROJECT_LIB)/libcpu$(LIB_VARIANT).a)

if LIBCHIP
SRCS += ../libchip/librtcio$(LIB_VARIANT).a
SRCS += ../libchip/libserialio$(LIB_VARIANT).a
SRCS += ../libchip/libide$(LIB_VARIANT).a
if HAS_NETWORKING
SRCS += ../libchip/libnetchip$(LIB_VARIANT).a
endif
endif

SRCS += $(wildcard $(PROJECT_LIB)/lib/rtems-ctor$(LIB_VARIANT).$(OBJEXT))

if HAS_MP
SRCS += ../libchip/shmdr$(LIB_VARIANT).rel
endif

all-local: $(TMPINSTALL_FILES)

$(ARCH)/librtemsbsp$(LIB_VARIANT).a: $(SRCS)
	rm -f $@
	$(mkdir_p) $(ARCH)
	rm -rf $(ARCH)/*.a $(ARCH)/*.$(OBJEXT) $(ARCH)/*.rel
	for f in $(SRCS); do \
	  case $$f in \
	  *.$(OBJEXT) | *.rel) \
	    if test -f $(ARCH)/`basename $$f`; then \
	      if cmp $$f $(ARCH)/`basename $$f`; then \
		true; \
	      else \
		echo 1>&2 "ERROR -- `basename $$f` in multiple files"; \
		exit 1; \
	      fi; \
	    else \
	      cp $$f $(ARCH)/; \
	      chmod a-w $(ARCH)/`basename $$f`; \
	    fi; \
	    ;; \
	  *.a) \
	    cd $(ARCH); \
	      $(AR) xv ../$$f || exit 1; \
	      chmod a-w * ; \
            cd ..; \
	    ;; \
	  esac; \
	done
	$(AR) rc $@ $(ARCH)/*
	rm -f $(ARCH)/*.$(OBJEXT) $(ARCH)/*.rel
	$(RANLIB) $@

TMPINSTALL_FILES =

$(PROJECT_LIB)/$(dirstamp):
	@$(mkdir_p) $(PROJECT_LIB)
	@: > $(PROJECT_LIB)/$(dirstamp)
TMPINSTALL_FILES += $(PROJECT_LIB)/$(dirstamp)

$(PROJECT_LIB)/librtemsbsp$(LIB_VARIANT).a: $(ARCH)/librtemsbsp$(LIB_VARIANT).a $(PROJECT_LIB)/$(dirstamp)
	$(INSTALL_DATA) $< $(PROJECT_LIB)/librtemsbsp$(LIB_VARIANT).a
TMPINSTALL_FILES += $(PROJECT_LIB)/librtemsbsp$(LIB_VARIANT).a

CLEANFILES += $(TMPINSTALL_FILES)

include $(top_srcdir)/automake/local.am
